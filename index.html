<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALCA PH Attendance</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family and apply bubblegum pink background -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap');
        body {
            background-color: #ffc1cc; /* Bubblegum pink */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .stylish-title {
            font-family: 'Poppins', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-2xl bg-white p-6 md:p-8 rounded-xl shadow-2xl border-b-8 border-pink-700">

        <!-- Title Section -->
        <div class="text-center mb-8">
            <div class="text-4xl mb-2">üëë</div>
            <h1 class="stylish-title text-5xl sm:text-6xl font-extrabold text-pink-600 tracking-wider mb-1">
                ALCA PH
            </h1>
            <p class="text-xl text-gray-700 font-semibold uppercase tracking-widest">
                Daily Attendance Record
            </p>
        </div>

        <!-- Input Section -->
        <div class="mb-6">
            <label for="nameInput" class="block text-lg font-medium text-gray-700 mb-2">Your Name:</label>
            <input type="text" id="nameInput" placeholder="Enter your full name"
                   class="w-full p-3 border-2 border-pink-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-pink-200 text-gray-800 transition duration-300"
                   required>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <button id="timeInBtn"
                    class="flex-1 p-4 bg-green-500 text-white font-bold rounded-xl text-xl shadow-lg hover:bg-green-600 transition duration-300 transform hover:scale-[1.02] active:scale-[0.98]">
                <span class="text-3xl mr-2">‚è±Ô∏è</span> Time In
            </button>
            <button id="timeOutBtn"
                    class="flex-1 p-4 bg-red-500 text-white font-bold rounded-xl text-xl shadow-lg hover:bg-red-600 transition duration-300 transform hover:scale-[1.02] active:scale-[0.98]">
                <span class="text-3xl mr-2">üö™</span> Time Out
            </button>
        </div>

        <!-- Real-time Clock and Status Message -->
        <div id="statusMessage" class="text-center p-3 rounded-lg bg-pink-100 border border-pink-300 text-pink-800 font-semibold mb-6 hidden">
            <!-- Messages appear here -->
        </div>

        <!-- Attendance Log Display -->
        <div class="bg-gray-50 p-4 rounded-xl shadow-inner max-h-96 overflow-y-auto border border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Recent Attendance Log</h2>
            <div id="attendanceLog" class="space-y-3">
                <!-- Log entries will be inserted here -->
            </div>
        </div>

        <!-- Instructions for Online Sync -->
        <div class="mt-6 text-sm text-center text-gray-500 p-2 bg-gray-100 rounded-lg">
            Attendance is saved offline in your browser. For online sync, please complete the Google Sheets setup described below.
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // CRITICAL: Replace this with your deployed Google Apps Script URL after following the tutorial.
        // If left empty, only local storage will work.
        const GOOGLE_SHEET_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwGeMemFY__ftw8PuNPkkxlrSkUmz175dLiI_iu2pv2QVtTQ-oO8lWOGzr1es2usdqY/exec";

        const nameInput = document.getElementById('nameInput');
        const timeInBtn = document.getElementById('timeInBtn');
        const timeOutBtn = document.getElementById('timeOutBtn');
        const attendanceLog = document.getElementById('attendanceLog');
        const statusMessage = document.getElementById('statusMessage');

        // --- Utility Functions ---

        /** Gets the current date and time in 12-hour format and separate date string. */
        const getCurrentDateTime = () => {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            return { date: dateStr, time: timeStr };
        };

        /** Displays a temporary status message to the user. */
        const showStatus = (message, isError = false) => {
            statusMessage.textContent = message;
            statusMessage.className = `text-center p-3 rounded-lg font-semibold mb-6 block transition duration-300 ${isError ? 'bg-red-100 border-red-300 text-red-800' : 'bg-green-100 border-green-300 text-green-800'}`;

            clearTimeout(window.statusTimer);
            window.statusTimer = setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        };

        // --- Data Handling: Local Storage ---

        /** Loads attendance data from local storage. */
        const loadAttendance = () => {
            try {
                const data = localStorage.getItem('alca_attendance');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Error loading attendance from local storage:", e);
                return [];
            }
        };

        /** Saves attendance data to local storage. */
        const saveAttendance = (data) => {
            try {
                localStorage.setItem('alca_attendance', JSON.stringify(data));
                renderLog(data);
            } catch (e) {
                console.error("Error saving attendance to local storage:", e);
                showStatus("Error: Could not save data locally. Storage limit reached.", true);
            }
        };

        // --- Data Handling: Online Sync (Google Sheets) ---

        /** Sends attendance data to Google Sheets via Web App. */
        const syncToSheets = async (entry) => {
            if (!GOOGLE_SHEET_WEB_APP_URL) {
                console.warn("Google Sheet Web App URL is not set. Skipping online sync.");
                return;
            }

            try {
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Apps Script Web App POST
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(entry),
                });
                console.log("Sheet sync initiated. Check Google Sheet for result.");
            } catch (error) {
                console.error("Error syncing to Google Sheets:", error);
            }
        };

        // --- Render UI ---

        /** Renders the attendance log to the DOM. */
        const renderLog = (data) => {
            attendanceLog.innerHTML = ''; // Clear existing entries

            if (data.length === 0) {
                attendanceLog.innerHTML = '<p class="text-gray-500 italic text-center">No entries recorded yet.</p>';
                return;
            }

            // Display latest entries first (reverse the array)
            const recentData = data.slice().reverse();

            recentData.forEach(entry => {
                const isCompleted = entry.timeOut;
                const entryElement = document.createElement('div');
                entryElement.className = `p-3 rounded-lg shadow-md transition duration-300 ${isCompleted ? 'bg-indigo-50 border border-indigo-200' : 'bg-yellow-50 border border-yellow-200 animate-pulse'}`;

                entryElement.innerHTML = `
                    <p class="font-bold text-lg text-gray-800">${entry.name}</p>
                    <p class="text-sm text-gray-600 mb-1">${entry.date}</p>
                    <div class="flex justify-between text-sm">
                        <span class="font-medium text-green-600">IN: ${entry.timeIn}</span>
                        <span class="font-medium ${isCompleted ? 'text-red-600' : 'text-gray-400'}">OUT: ${entry.timeOut || 'Pending...'}</span>
                    </div>
                `;
                attendanceLog.appendChild(entryElement);
            });
        };

        // --- Event Handlers ---

        timeInBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (!name) {
                showStatus("Please enter your name to clock in.", true);
                nameInput.focus();
                return;
            }

            const attendanceList = loadAttendance();
            const { date, time } = getCurrentDateTime();

            // Check for existing pending entry by the same name
            const hasPendingEntry = attendanceList.some(entry => entry.name === name && !entry.timeOut);

            if (hasPendingEntry) {
                 showStatus(`Hello ${name}, you already have a pending Time In. Please Time Out first.`, true);
                 return;
            }

            // Create new entry
            const newEntry = {
                id: Date.now(),
                name: name,
                date: date,
                timeIn: time,
                timeOut: null,
                status: 'IN' // For Google Sheet purposes
            };

            attendanceList.push(newEntry);
            saveAttendance(attendanceList);
            nameInput.value = ''; // Clear name input after successful action
            showStatus(`‚úÖ Time In recorded for ${name} at ${time}.`);

            // Online Sync
            syncToSheets(newEntry);
        });

        timeOutBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (!name) {
                showStatus("Please enter your name to clock out.", true);
                nameInput.focus();
                return;
            }

            const attendanceList = loadAttendance();
            const { time } = getCurrentDateTime();

            // Find the latest pending entry for this user
            const latestEntryIndex = attendanceList.findIndex(entry => entry.name === name && !entry.timeOut);

            if (latestEntryIndex === -1) {
                showStatus(`‚ùå Error: No pending Time In found for ${name}. Please Time In first.`, true);
                return;
            }

            // Update the entry with Time Out
            const entryToUpdate = attendanceList[latestEntryIndex];
            entryToUpdate.timeOut = time;
            entryToUpdate.status = 'OUT'; // Update status for Google Sheet

            saveAttendance(attendanceList);
            nameInput.value = ''; // Clear name input after successful action
            showStatus(`‚úÖ Time Out recorded for ${name} at ${time}. Great job today!`);

            // Online Sync
            syncToSheets(entryToUpdate);
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderLog(loadAttendance());
            // Optional: Set up a recurring interval to clear the log for privacy/storage reasons
            // or just rely on the user to manually clear it if needed.
        });

    </script>
</body>
</html>